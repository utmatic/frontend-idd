<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InDesign Processor</title>
  <style>
    #status { margin-top: 1.5em; font-weight: bold; }
    #downloads { margin-top: 2em; }
    button[disabled] { opacity: 0.6; }
  </style>
</head>
<body>
  <h1>Submit InDesign File for Processing</h1>
  <form id="iddForm" enctype="multipart/form-data">
    <label>Upload InDesign File (.indd):
      <input type="file" name="file" accept=".indd" required>
    </label><br><br>

    <label>Target Formats (one per line, e.g., NNNN-NNNN):
      <textarea name="target_formats" rows="5" cols="40" required></textarea>
    </label><br><br>

    <label>Base URL:
      <input type="text" name="base_url" value="https://www.agilent.com/store/productDetail.jsp?catalogId=" required>
    </label><br><br>

    <label>UTM Source:
      <input type="text" name="utm_source" required>
    </label><br>

    <label>UTM Medium:
      <input type="text" name="utm_medium" required>
    </label><br>

    <label>UTM Campaign:
      <input type="text" name="utm_campaign" required>
    </label><br><br>

    <button type="submit" id="submitBtn">Submit</button>
  </form>
  <div id="status"></div>
  <div id="downloads"></div>

  <script>
    const form = document.getElementById('iddForm');
    const statusDiv = document.getElementById('status');
    const downloadsDiv = document.getElementById('downloads');
    const submitBtn = document.getElementById('submitBtn');

    form.onsubmit = async (e) => {
      e.preventDefault();
      statusDiv.textContent = "";
      downloadsDiv.innerHTML = "";
      submitBtn.disabled = true;

      const formData = new FormData(form);

      statusDiv.textContent = "Uploading and initializing job...";
      try {
        const resp = await fetch("https://backend-idd.onrender.com/upload/", {
          method: "POST",
          body: formData
        });

        const res = await resp.json();
        if (resp.ok && res.job_id) {
          statusDiv.textContent = "Processing your file, please wait...";
          pollStatus(res.job_id);
        } else {
          statusDiv.textContent = "Error: " + (res.error || "Unknown error");
          submitBtn.disabled = false;
        }
      } catch (err) {
        statusDiv.textContent = "Network error: " + err;
        submitBtn.disabled = false;
      }
    };

    async function pollStatus(jobId) {
      let timer;
      async function check() {
        try {
          const resp = await fetch(`https://backend-idd.onrender.com/job_status/${jobId}`);
          const res = await resp.json();
          if ((res.processed_ready || res.report_ready) && (res.processed_url || res.report_url)) {
            statusDiv.textContent = "Your files are ready!";
            downloadsDiv.innerHTML = `
              ${res.processed_ready ? `<a href="${res.processed_url}" download><button>Download Processed INDD</button></a>` : ""}
              ${res.report_ready ? `<a href="${res.report_url}" download><button>Download Hyperlink Report</button></a>` : ""}
            `;
            submitBtn.disabled = false;
            return;
          } else {
            statusDiv.textContent = "Still processing... (this may take a minute)";
          }
        } catch (e) {
          statusDiv.textContent = "Waiting for processing (connection issue, retrying...)";
        }
        timer = setTimeout(check, 4000);
      }
      check();
    }
  </script>
</body>
</html>
